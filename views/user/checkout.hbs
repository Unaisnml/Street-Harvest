<html lang="zxx">

  <head>
    <meta charset="UTF-8" />
    <meta name="description" content="Ashion Template" />
    <meta name="keywords" content="Ashion, unica, creative, html" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title></title>

  </head>

  <body>
    <section class="checkout spad">
      <div class="container">
        <div class="row">

          <div class="col-lg-12">

            {{#each viewCoupon}}
              <h6 class="mb-2"><span class="icon_tag_alt"></span>
                <input
                  type="text"
                  value="{{this.CouponName}}"
                  id="myInput"
                  style="color: red; font-weight: bold"
                />
                <button
                  class="tp_btn btn-success"
                  onclick="myFunction()"
                >Copy</button>
              </h6>
            {{/each}}
            <h6 class="mb-5"><span class="icon_tag_alt"></span>
              <input type="text" placeholder="Enter coupon code" id="coupon" />
              <button class="tp_btn btn-warning" onclick="applyCoupon()">Apply
                Coupon</button>
            </h6>
          </div>
        </div>

        <form
          action="/checkout"
          method="post"
          id="checkout-form"
          class="checkout__form"
        >
          <div class="row">
            <div class="col-lg-8">
              <h5>Billing detail</h5>
              <div class="row">
                <div class="col-lg-6 col-md-6 col-sm-6">
                  <div class="checkout__form__input">
                    <p>NAME<span>*</span></p>
                    <input
                      type="text"
                      id="name"
                      name="name"
                      value="{{selectAddress.name}}"
                      required
                    />
                  </div>
                </div>
                <div class="col-lg-6 col-md-6 col-sm-6">
                  <div class="checkout__form__input">
                    <p>EMAIL<span>*</span></p>
                    <input
                      type="email"
                      id="email"
                      name="email"
                      value="{{selectAddress.email}}"
                      required
                    />
                  </div>
                </div>
                <div class="col-lg-6 col-md-6 col-sm-6">
                  <div class="checkout__form__input">
                    <p>MOBILE<span>*</span></p>
                    <input
                      type="number"
                      id="mobile"
                      name="mobile"
                      value="{{selectAddress.mobile}}"
                      required
                    />
                  </div>
                </div>
                <div class="col-lg-12">
                  <div class="checkout__form__input">
                    <p>ADDRESS<span>*</span></p>
                    <input
                      type="text"
                      id="address"
                      name="address"
                      value="{{selectAddress.address}}"
                      required
                    />
                  </div>
                </div>
                <div class="col-lg-6 col-md-6 col-sm-6">
                  <div class="checkout__form__input">
                    <p>TOWN/CITY<span>*</span></p>
                    <input
                      type="text"
                      id="town"
                      name="town"
                      value="{{selectAddress.town}}"
                      required
                    />
                  </div>
                </div>
                <div class="col-lg-6 col-md-6 col-sm-6">
                  <div class="checkout__form__input">
                    <p>DISTRICT <span>*</span></p>
                    <input
                      type="text"
                      id="district"
                      name="district"
                      value="{{selectAddress.district}}"
                      required
                    />
                    <input
                      type="text"
                      name="userId"
                      id="userId"
                      value="{{users._id}}"
                      hidden
                    />
                    <input
                      type="text"
                      name="discount"
                      id="offer"
                      value="0"
                      hidden
                    />
                    <input
                      type="text"
                      name="grandTotal"
                      id="finalprice"
                      value="{{total}}"
                      hidden
                    />
                  </div>
                </div>
                <div class="col-lg-6 col-md-6 col-sm-6">
                  <div class="checkout__form__input">
                    <p>STATE<span>*</span></p>
                    <input
                      type="text"
                      id="state"
                      name="state"
                      value="{{selectAddress.state}}"
                      required
                    />
                  </div>

                </div>
                <div class="col-lg-6 col-md-6 col-sm-6">
                  <div class="checkout__form__input">
                    <p>PINCODE<span>*</span></p>
                    <input
                      type="number"
                      id="pincode"
                      name="pincode"
                      value="{{selectAddress.pincode}}"
                      required
                    />
                  </div>

                </div>
              </div>
            </div>
            <div class="col-lg-4">
              <div class="checkout__order">
                <h5>Your order</h5>
                <div class="checkout__order__product">
                  <ul>
                    <li><a href="#">Product <span>Total</span></a></li>
                    {{#each products}}
                      <li><a href="#">{{product.Name}}
                          <span class="middle">x {{this.quantity}}</span>
                          <span
                            class="last"
                          >{{this.product.Price}}</span></a></li>
                    {{/each}}
                  </ul>
                </div>
                <div class="checkout_order_total">
                  <ul class="list-group">
                    <li class="list-group-item">Subtotal:
                      <span id="subTotal">{{total}}</span></li>
                    <li class="list-group-item"><a>Discount:
                        <span id="discount"></span></a></li>
                    <li class="list-group-item">Total:
                      <span id="grandTotal">{{total}}</span></li>
                  </ul>
                </div>

                <div class="checkout__order__widget">
                  <div class="my-4">
                    <h6>Choose Payment Method </h6>
                  </div>
                  {{! payement-method-bootstrap start}}
                  <div class="form-check">
                    <input
                      type="radio"
                      class="form-check-input"
                      value="COD"
                      name="payement-method"
                      id="check-payement"
                    />
                    <label class="form-check-label" for="flexRadioDefault1">
                      COD
                    </label>
                  </div>
                  <div class="form-check">
                    <input
                      type="radio"
                      class="form-check-input"
                      value="ONLINE"
                      name="payement-method"
                      id="check-payement-1"
                    />
                    <label class="form-check-label" for="flexRadioDefault2">
                      Online
                    </label>
                  </div>
                  {{! payement-method-bootstrap end}}

                </div>
                <button type="submit" class="site-btn">Place oder</button>
              </div>
            </div>
          </div>
        </form>
      </div>

    </section>

    {{! address start}}
    <div class="accordion" id="accordionExample">
      {{#each userAddress}}
        <div class="card">
          <div class="card-header" id="headingOne">
            <h2 class="mb-0">
              <button
                class="btn btn-link btn-block text-left"
                type="button"
                data-toggle="collapse"
                data-target="#collapseOne"
                aria-expanded="true"
                aria-controls="collapseOne"
              >
                Address:
                {{inc @index}}
              </button>
            </h2>
          </div>

          <div
            id="collapseOne"
            class="collapse show"
            aria-labelledby="headingOne"
            data-parent="#accordionExample"
          >
            <div class="card-body">

              <p>Name:{{this.name}}</p>
              <p>Email:{{this.email}}</p>
              <p>Mobile:{{this.mobile}}</p>

              <p>Address:{{this.address}}</p>
              <p>Town/City:{{this.town}}</p>
              <p>District:{{this.district}}</p>
              <p>State:{{this.state}}</p>
              <p>Pincode:{{this.pincode}}</p>
            </div>
            <div>
              <a href="/checkout?id={{this.id}}" class="tp_btn ml-3">Select</a>
              {{! <button type="submit" class="tp_btn ml-3">Select</button> }}
            </div>
          </div>
        </div>
      {{/each}}

    </div>

    {{! address end}}

    <!-- Search Begin -->
    <div class="search-model">
      <div class="h-100 d-flex align-items-center justify-content-center">
        <div class="search-close-switch">+</div>
        <form class="search-model-form">
          <input type="text" id="search-input" placeholder="Search here....." />
        </form>
      </div>
    </div>
    <!-- Search End -->

  </body>

</html>

<script>

  $("#checkout-form").submit((e) => {
     e.preventDefault()
      $.ajax({ 
      url:'/checkout',
       method: 'post',
      data: $('#checkout-form').serialize(),
       success:(response) => {
         if (response.codSuccess) {
           location.href = '/order-success'
  } else {
     razorpayPayment(response)
      } 
      } 
      })
     }) 
      

    function razorpayPayment(order) {
  var options = { 
    "key": "rzp_test_WHDWrOcFGOoWv2", // Enter the Key ID generated from the Dashboard 
    "amount": order.amount, // Amount is in currencysubunits. Default currency is INR. Hence, 50000 refers to 50000 paise
  "currency": "INR",
   "name": "ToyCare", 
   "description": "Test Transaction",
  "image": "https://example.com/your_logo",
   "order_id": order.id, //This is asample Order ID. Pass the `id` obtained in the response of Step 1
    "handler":function (response) {
       verifyPayment(response,order)
        },
         "prefill": { 
          "name":"Gaurav Kumar",
           "email": "gaurav.kumar@example.com",
            "contact": "9999999999"
  }, 
  
  "notes": {
     "address": "Razorpay Corporate Office"
      }, 
      "theme": { 
        "color": "#3399cc" 
        } 
        }; 
        
        var rzp1 = new Razorpay(options);
         rzp1.open();
          } 


  function verifyPayment(payement, order) {
             $.ajax({
               url: '/verify-payment',
                data: {
                   payement, order
                    },               
                    method: 'post',
                     success:(response)=>{
                       if(response.status){
                        Swal.fire(
      'payment successful',
      '',
      'success'
     )
                        location.href = '/order-success'
                         }else{ 
                          alert("Payment failed")
                           }
                            }
                             })
                              }


  function applyCoupon() {
     var userId = document.getElementById('userId').value
  console.log(userId)
   var coupon = document.getElementById('coupon').value
  var subTotal = document.getElementById('subTotal').innerHTML
   $.ajax({
     url:'/apply-coupon', 
     data: { 
      couponName: coupon,
      userId: userId
       },
    method: 'post',
  success: (response) => {
     if (response.expired) { 
      alert("Sorry coupon haveexpired") 
      } else if (response.notAvailable) {
         alert("Invalid coupon")
          } else if (response.used) {
             alert("Coupon already used") 
             } else { 
              var discount =response.Value
               var grandTotal = subTotal - discount
  document.getElementById('discount').innerHTML = discount
  document.getElementById('grandTotal').innerHTML = grandTotal
  document.getElementById('offer').value = discount
  document.getElementById('finalprice').value = grandTotal 
  } 
  } 
  }) 
  }
</script>

<script>
  function myFunction() { // Get the text field var copyText =
  document.getElementById("myInput"); // Select the text field
  copyText.select(); 
  copyText.setSelectionRange(0, 99999); // For mobile devices
  // Copy the text inside the text field
  navigator.clipboard.writeText(copyText.value); 
  Swal.fire('Coupon Copied') } // Alert the copied text
  </script>

  <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>